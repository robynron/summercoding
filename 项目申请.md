<center><font size=20 face="黑体">项目申请书</font></center>

<center><font size=3 face="黑体">项目名称：支持GTS通信协议和消息</font></center>

<center><font size=3 face="黑体">项目主导师：赵学良</font></center>

<center><font size=3 face="黑体">申请人：刘戎</font></center>

<center><font size=3 face="黑体">日期：2022.6</font></center>

<center><font size=3 face="黑体">邮箱：767817253@qq.com</font></center>



# 1.项目背景

## 1.1 seata

Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。

## 1.2 txc/gts

GTS 是一款阿里云云产品，用于实现分布式环境下，特别是微服务架构下的高性能事务一致性。

## 1.3 项目需求

目前Seata支持了自定义协议格式参考:https://github.com/seata/seata/issues/893 
需要进一步支持TXC/GTS 产品的通信协议，在seata-server侧能够无缝兼容2种通信协议并且支持TXC/GTS 的事务消息处理，以达到使用TXC/GTS  client的用户也可以通过 txc-client 使用 seata-server 提供的分布式事务服务。

# 2.技术方法及可行性

## 2.1 seata相关

2022年四月份担任阿里巴巴MSE团队分布式事务服务的实习生，期间调研了seata的事务模式，并在seata社区解决了部分issue，对seata的工作模型较为了解。个人在担任实习生期间，会高频参与到seata开源项目中,并会将大部分时间投入到seata开源项目中。

# 3.项目实现细节

## 3.1 seata/gts架构对比

![seata/gts架构图](https://github.com/robynron/summercoding/blob/master/seata:gts.png)
在GTS的产品介绍中，可知Seata 的分布式事务框架源自 GTS，二者的底层架构和事务协议是完全一致的：
* GTS 把 TM 和 RM 的实现统一打包到 GTS SDK（GTS Client） 中。
* GTS 服务端（GTS Server）就是 TC 的一个高可用实现。
  基于上述对比，只要实现具体网络通信机制上的兼容适配，就可以完整支撑 Seata 应用运行在 GTS 服务之上。

## 3.2 seata与 txc/gts通信协议

seata-server在 [issues #893](https://github.com/seata/seata/issues/893) 中重新定义了rpc协议：
```
0     1     2     3     4     5     6     7     8     9     10    11    12    13    14    15    16
+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
|   magic   |Proto|     Full length       |    Head   | Msg |Seria|Compr|     RequestId         |
|   code    |colVer|    （head+body)      |   Length  |Type |lizer|ess  |                       |
+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+
|                                                                                               |
|                                   Head Map [Optional]                                         |
+-----------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+
|                                                                                               |
|                                         body                                                  |
|                                                                                               |
|                                        ... ...                                                |
+-----------------------------------------------------------------------------------------------+
```
TXC/GTS仍然沿用seata老版本的传输协议:
```
0     1     2     3     4           6           8          10           12          14         16
+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
|   0xdada  |   flag    | typecode/ |                 requestid                     |           |
|           |           | bodylength|                                               |           |
+-----------+-----------+-----------+-----------+-----------+-----------+-----------+           +
|                                    ... ...                                                    |
+                                                                                               +
|                                     body                                                      |
+                                                                                               +
|                                    ... ...                                                    |
+-----------------------------------------------------------------------------------------------+
```
## 3.3 seata-server与txc/gts-client通信协议与事务模式兼容

seata-server端decode TXC/GTS的消息体时，会按照最新的seata-server协议格式解析。为实现二者协议兼容，需要首先判断接收到的消息体所使用的协议版本；对于TXC/GTS协议格式的消息体解析，并转换为seata-server的协议格式（对于seata的head部分TXC/GTS协议不存在的字段，使用默认值）。

seata-server相比于TXC/GTS服务端，能支持更多的全局事务模式，可实现TXC/GTS大部分事务模式，对于未兼容的事务模式，则需要在seata-server中迁移TXC/GTS服务端的事务处理逻辑，已实现兼容。

# 4.规划

## 4.1 项目研发第一阶段（7月1日-7月15日）
熟悉并阅读源码：seata与TXC/GTS消息体协议与消息体解析流程、事务模式执行处理交互流程


## 4.2 项目研发第二阶段（7月15日-8月15日）
与导师商讨方案的可行性；
研发：seata-server兼容TXC/GTS通信协议，并支持TXC/GTS 的事务消息处理；

## 4.3 项目研发第三阶段（8月16日-9月15日）
对第二阶段的方案进行功能、性能测试
总结并思考改进的地方

## 4.4 项目研发第四阶段（9月16日-9月30日）
对项目优化、改进、总结

## 4.3 期望
希望本人能借此机会提升代码能力，学习新的知识；
同时期望seata能够兼容TXC/GTS的事务模式，使得seata产品更具优势。


